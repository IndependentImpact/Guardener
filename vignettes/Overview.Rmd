---
title: "Guardener"
author: "Christiaan Pauw and Alex Howard"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, echo = FALSE, warning = FALSE, collapse = TRUE,
  comment = "#>"
)
library(Guardener)
library(tidyverse)
```

# Get access token

You need to have a username and password. For the defaults, Uuse usethis::edit_r_environ() to edit the R environment. These value are be retrieved with Sys.getenv("guardianUn") and Sys.getenv("guardianPW")

```{r}
ATL <- Glogin(un = "StandardRegistry", pw =  "test")
ATL$role
ATL$did
ATL$username
AT <- ATL$accessToken # only the accestoken
```

# Get list of policies 

If the role is Standards Regsitry (or installer?), the use can request a policy list (of tibble when returndf = TRUE )

```{r }
dfPolicies <- GgetPolicies(AT, returndf = TRUE)
```


# Get an individual policy

```{r}
policyid <- dfPolicies$id[[4]]
policyids <- dfPolicies$id
policy <- GgetPolicy(AT, policyId = policyid, returndf = TRUE)
```
Information about the block are inside the $config column

Inspect the config:

```{r}
dfConfig <- GgetPolicyConfig(accessToken = AT,  policyId = policyid) %>% 
  unnest(cols = c(children)) %>% 
   unnest(cols = c(children))
```

# Get blocks from policy

Do all of the above in one step

```{r}
blocks <- GgetPolicyBlocks(AT, policyId = policyid)
```

Relevant blocks for action are typically of type "requestVcDocumentBlock"

```{r}
blocks %>% filter(blockType == "requestVcDocumentBlock")
```
# Get schemas associated with block

```{r}
#Schema_requestVcDocumentBlock <- GgetSchemas(AT, schemaId = unlist(blocks[1, c(8)]), returndf = TRUE)
dfSchemas <- GgetSchemas(AT,  returndf = TRUE) # "/schema/{schemaId}" gives a 500 so get everything and filter
```


```{r}
dfTemplates <- dfSchemas %>% 
  GmakeSchemaTemplate() %>% 
  mutate(templ = map(data, ~names2tibble(.) )) %>% 
  ungroup() %>% 
  select(-data)
```

Populate the Monitoring Report (MR)  tempate and submit.

```{r}
dfM <- dfTemplates %>% filter(name == "Monitoring Report (MR)") %>% unnest(templ)
```



